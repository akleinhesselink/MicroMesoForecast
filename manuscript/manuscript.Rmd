---
layout: 12pt
header-includes:
   - \usepackage{lineno}
   - \linenumbers
   - \usepackage{setspace}
   - \doublespacing
bibliography: ~/Dropbox/Bibliography/MicroMeso.bib
csl: components/ecology.csl

## rmarkdown render options
output:
  pdf_document:
    fig_caption: true
    keep_tex: true
fontsize: 12pt
mainfont: times
geometry: margin=1in

---

Do we need detailed demographic data to forecast population responses to climate change?
========================================================================================

### Andrew T. Tredennick and Peter B. Adler

*Andrew T. Tredennick ([atredenn@gmail.com](mailto:atredenn@gmail.com)), Department of Wildland Resources and the Ecology Center, Utah State University, Logan, UT*

*Peter B. Adler, Department of Wildland Resources and the Ecology Center, Utah State University, Logan, UT*

```{r libraris, include=FALSE}
library(ggplot2)
library(plyr)
library(gridExtra)
library(reshape2)
library(xtable)
library(ggmcmc)
```

```{r caching, include=FALSE}
library("methods")
library("knitr")
basename <- "manuscript"
opts_chunk$set(fig.path = paste("components/figure/", basename, "-", sep=""),
               cache.path = paste("components/cache/", basename, "/", sep=""))
opts_chunk$set(cache = 2)
opts_chunk$set(tidy=FALSE, warning=FALSE, message=FALSE, 
               comment = NA, verbose = TRUE, echo=FALSE)

# PDF-based figures
opts_chunk$set(dev='pdf')
```


```{r plot-options, message=FALSE, warning=FALSE, include=FALSE, echo=FALSE}
cbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", 
               "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

opts_chunk$set(dev='pdf', dev.args=c(version="1.3"))

```

Abstract
--------

*Keywords*: forecasting, climate change, grassland, integral projection model

Introduction
------------
Population models are important tools for predicting the impacts of environmental change on species. But reconciling the scales at which population models are parameterized and the scales at which environmental changes play out remains a challenge [@Clark2010; @Freckleton2011; @Queenborough2011; @Clark2012]. The major hurdle is that most population models, at least for plant species, are built using data from small, localized plots because parameterizing traditional population models requires tracking the fates of individuals. These models are difficult to scale up from the micro to meso-scales because the fitted parameters do not fully represent the spatial variation present at scales beyond that at which the data are collected [@SÃ¦ther2007]. At the same time, most demographic data is collected over short time spans. For example, the most common study duration in the COMPADRE matrix population model database is 4 years and only a few exceed 10 years [@Salguero-Gomez2015]. The constrained spatio-temporal extent of most demographic datasets reflects the difficulty of collecting such data, but those constraints limit our ability to extrapolate population models. Thus, our ability to use population models to predict the consequences of climate change is limited when we rely on individual-level data.

Aggregate measures of individual plant performance, such as those typically collected as part of large-scale census efforts, offer an alternative to detailed demographic data for modeling populations [@Clark2004; @Freckleton2011]. Such population-level data will never match the precision of individual-level data, but it is more feasible to attain a broad coverage sample when collecting coarse-scale data. This presents a difficult trade-off: on the one hand, individual-level data leads to more reliable models; on the other hand, population-level data leads to models that will produce less precise predictions but can be applied over greater spatial and temporal extents. An open question is how well models based on population-level data compare to models based on individual-level data.

To date, relatively few studies have tried to model populations based on data other than detailed individual-level data. An important exception is an effort by @Taylor2004 to model the population growth rate of an invasive species to investigate the best strategies for invasion control. They used a "density-structured" model where the state variable is a discrete density state rather than a continuous density measure. Building on this work, @Freckleton2011 showed that density-structured models compare well to continuous models in theory, and @Queenborough2011 showed the application of such methods in a study on arable weeds. In particular, @Queenborough2011 provide empirical evidence that density-structured models are capable of reproducing population dynamics, even if some precision is lost when compared to fully continuous models. Thus, population models based on coarse, population-level data show promise for producing ecological forecasts at landscape and regional scales [@Queenborough2011]. However, none of these models included environmental covariates.

Basing population models on aggregated individual-level data in a climate change context is hampered by the fact that it is individuals that respond to climate, not populations [@Clark2012]. This fact puts us in uneasy proximity to an "ecological fallacy" where one deduces inference on the individual from statistical inference on the group [@PIANTADOSI1988]. For example, individual plants may respond positively to precipitation but a negative trend is observed at the population level due to increased competition among plants as they grow larger and consume more resources. Thus, it is important to ask the question: Can aggregated data be used to detect climate signals of the same sign and magnitude as individual-level data? If not, then building population models with climate covariates on aggregated data will lead to incorrect forecasts.

Here, we test the assumption that statistical and population models based on aggregated data can detect climate signals as wells as models based on individual-level data. We use a unique demographic dataset that tracks the fates of individual plants from four species over 14 years to build single-species population models, since those are often used tools for ecological forecasts and climate vulnerability assessments. We first fit population models with interannual variation in vital rates explained, in part, by climate covariates. We then perturb the climate covariates to test the sensitivities of species to climate change. By doing these analyses using both individual and aggregated forms of the same data, we provide a rigorous test of our hypothesis. We find that...  

Materials and Methods
---------------------
### Study site and data
Our demographic data comes from the Fort Keogh Livestock and Range Research Laboratory in eastern Montana's northern mixed prairie near Miles City, Montana, USA ($46^{\circ}$ 19' N, $105^{\circ}$ 48' W). The dataset is freely available on Ecological Archives [@Anderson2011], and interested readers should refer to the metadata therein for a complete description. The site is about 800 m above sea level and mean annual precipitation (1878-2009) is 334 mm, with most annual precipitation falling from April through September. The site is grass dominated and, for the purposes of our study, we focus on the four most abundant graminoid species: \emph{Bouteloua gracilis} (BOGR), \emph{Hesperostipa comata} (HECO), \emph{Pascopyrum smithii} (PASM), and \emph{Poa secunda} (POSE). 

From 1932 to 1945 individual plants were identified and mapped annually in 44 1-$\text{m}^2$ quadrats using a pantograph. The quadrats were distributed in six pastures, each assigned a grazing treatment of light (1.24 ha/animal unit month), moderate (0.92 ha/aum), and heavy (0.76 ha/aum) stocking rates (two pastures per treatment). In this analysis we account for potential differences among the grazing treatments, but do not focus on grazing$\times$climate interactions. The annual maps of the quadrats were digitized and the fates of individual plants tracked and extracted using a computer program. Daily climate data, which we aggregated into climate variables of interest, are available for the duration of the data collection period (1932 - 1945) from the Miles City airport, Wiley Field, 9 km from the study site.

In this paper, we model populations based on two levels of data: individual and quadrat. The individual data is the "raw" data. For the quadrat level we data we simply sum individual areal cover for each quadrat by species. This is equivalent to a perfect census of quadrat percent cover, so we do not need to consider measurement error. Based on these two datasets we can compare population models built using individual level data and aggregated quadrat level data.

### Stastical models of vital rates
At both levels of inference (individual and quadrat), the building blocks of our population models are vital rate regressions. For individual level data we fit models for survival, growth, and recruitment of new individuals for each species. At the quadrat level we fit a single regression model for population growth. We describe the statistical models separately since fitting the models required different approaches. All models contain five climate covariate that we chose \emph{a priori}: "water year" precipitation at \emph{t}-1 (lagppt); fall through spring precipitation at \emph{t}-1 and \emph{t}-2 (ppt1 and ppt2, respectively) and mean spring temperature at \emph{t}-1 and \emph{t}-2 (TmeanSpr1 and TmeanSpr2, respectively), where \emph{t} is the observation year.

We fit all models using a hierarchical Bayesian approach, which we describe in more detail below. However, for each vital rate statistical model we also define the likelihood model we use. For the likelihood models, \textbf{Y} is always the relevant vector of observations (e.g., whether a  genet survived [1] or not [0] from year $t$ to $t+1$). 

#### Vital rate models at the individual level
We used logistic regression to model survival probability ($S$) of genet $i$ from species $j$ in quadrat group $Q$ from time $t$ to $t+1$:

\begin{align}
\text{logit}(S_{ijQ,t}) &= \gamma^{S}_{j,t} + \phi^{S}_{jQ} + \beta^{S}_{j,t}x_{ij,t} + \omega^{S}_{j}w_{ij,t} + \theta^{S}_{jk}C_{k,t} + \varepsilon^{S}_{t} \\
Y^{S}_{ijQ,t} &\sim \text{Bernoulli}(S_{ijQ,t})
\end{align}

where $x_{ij,t}$ is the log of genet size, $\gamma^{S}_{j,t}$ is a year-specific intercept, $\beta^{S}_{j,t}$ is the year-specific slope parameter for size, $\phi^{S}_{jQ}$ is the random effect of quadrat group location, and $\theta^{S}_{k}$ is the fixed parameter for the effect of the $k$th climate covariate at time $t$ ($C_{k,t}$). We include density-dependence by estimating the effect of crowding on the focal individual by other individuals of the same species. $\omega$ is the effect of crowding and $w_{t,Q}$ is the crowding experienced by the focal individual at time $t$ in quadrat group $Q$.

We modeled growth as Gaussian process describing genet size at time $t+1$ as a function of size at $t$ and climate covariates:

\begin{align}
x_{ijQ,t+1} &= \gamma^{G}_{j,t} + \phi^{G}_{jQ} + \beta^{G}_{j,t}x_{ij,t} + \omega^{G}_{j}w_{ij,t} + \theta^{G}_{jk}C_{k,t} \\
Y^{G}_{ijQ,t} &\sim \text{Normal}(x_{ijQ,t+1}, \sigma_{j})
\end{align}

where $x$ is log genet size and all other parameters are as described for the survival regression.

Our data allows us to track new recruits, but we cannot assign a specific parent to new genets. So, for recruitment, we work at the quadrat level and model the number of new individuals of species $j$ in quadrat $q$ recruiting at time $t+1$ as a function of quadrat "effective cover" ($A'$) in the previous year ($t$). Effective cover is a mixture of observed cover ($A$) in the focal quadrat ($q$) and the mean cover across the entire group ($\bar{A}$) of $Q$ quadrats in which $q$ is located:

\begin{equation}
A'_{jq,t} = p_{j}A_{jq,t} + (1-p_{j})\bar{A}_{jQ,t}
\end{equation}

where $p$ is a mixing fraction between 0 and 1 that is estimated within the model.

We assume the number of individuals, $Y^{R}$, recruiting at time $t+1$ follows a negative binomial distribution:

\begin{equation}
Y^{R}_{jq,t+1} \sim \text{NegBin}(\lambda_{jq,t+1},\zeta)
\end{equation}

where $\lambda$ is the mean intensity and $\zeta$ is the size parameter. We define $\lambda$ as:

\begin{equation}
\lambda_{jq,t+1} = A'_{jq,t}e^{(\gamma^{R}_{j,t} + \phi^{R}_{jQ} + \theta^{R}_{jk}C_{k,t} + \omega^{R}\sqrt{A'_{q,t}})}
\end{equation}

where $A'$ is effective cover ($\text{cm}^2$) of species $j$ in quadrat $q$ and all other terms are as in the survival and growth regressions.

#### Population model at the quadrat level
The statistical approach used to model vital rates using aggregated data depends on the type of data collected. In our case, and as is often the case with census data, we have percent cover data (which can easily be transformed to proportion data, of course). We first considered fitting three vital rate models analagous to those we fit at the individual level: one for probability of extirpation within a quadrat (analagous to survival), one for cover change within a quadrat (analagous to growth), and one for probability of colonization within a quadrat (analagous to recruitment). However, within-quadrat extirpation and colonization events were rare in our time series ($N=9$ and $N=10$, respectively across all species). Given the broad spatial distribution of the quadrats we are studying, it is safe to assume that these events are in fact rare enough to be ignored for our purposes. So we constrained our statistical modeling of vital rates at the population level to change in percent cover within quadrats. For the remaining discussion of statistical modeling we refer to proportion data, which is simply percent data divided by 100.

An obvious choice for fitting a linear model to proportion data is beta regression because the support of the beta distribution is [0,1], not including true zeros or ones. However, when we used fitted model parameters from a beta regression in a quadrat-based population model the simulated population tended toward 100% cover for all species. We therefore chose a more constrained modeling approach based on a truncated log-normal likelihood. The model for quadrat cover change ($G$) from time $t$ to $t+1$ is

\begin{align}
x_{jq,t+1} &= \gamma^{G}_{j,t} + \phi^{G}_{jQ} + \beta^{G}_{j,t}x_{jq,t} + \theta^{S}_{jk}C_{k,t} \\
Y^{G}_{jq,t+1} &\sim \text{LogNormal}(x_{jq,t+1}, \tau{j}) T[0,1]
\end{align}

where $x_{jq,t}$ is the log of species' $j$ proportional cover in quadrat $q$ at time $t$ and all other parameters are as in the individual-level growth model (Eq. #). The log normal likelihood includes a truncation ($T$[0,1]) to ensure that predicted values do not exceed 100% cover. 

### Model fitting
Our Bayesian approach to fitting the vital rate models required choosing appropriate priors for unknown parameters and deciding which, if any, of those priors should be hierarchical. We decided to fit models where all terms except climate covariates were fit by species, while the climate covariates were fit hierarchically with species-specific coefficients drawn from a shared `global' coefficient distribution. We did so for two reasons: (1) the four focal species are all perennial grasses that we expect to respond similarly to climate covariates, and (2) convergence of climate effects at the quadrat level was much easier to achieve when we modeled these terms hierarchically, allowing them to "share" statistical strength via partial pooling [@Gelman2007]. So, climate effects were modeled as:

\begin{align}
\theta_{jk} &\sim \text{Normal}(\bar{\theta_{k}}, \sigma_{k})
\end{align}

where $\bar{\theta_{k}}$ is the interspecific effect of the $k$th climate covariate.

We used uninformative priors for all unknown parameters, specifically:

\begin{align}
\boldsymbol{\gamma, \beta, \bar{\theta}} &\sim \text{Normal}(0, 1e^{-6}) \\
\boldsymbol{\phi} &\sim \text{Normal}(0, \boldsymbol{\sigma_{\phi}}) \\
\boldsymbol{\sigma_{\phi}} &\sim e^{(\text{Gamma}(2, 0.5))} \\
\boldsymbol{\sigma_{\theta}, \sigma_{\gamma}, \sigma_{\beta}, \tau, \zeta} &\sim \text{Gamma}(0.001, 0.001)
\end{align}

All of our analyses (model fitting and simulating) were conducted in R [@Team2013]. We used the MCMC sampler in JAGS [@Plummer2003] to estimate the posterior distributions of model parameters and the package 'rjags' to connect R to JAGS. We obtained posterior distributions for all model parameters from three parallel MCMC chains run for 50,000 iterations, thinned by 50, after discarding an initial 50,000 iterations. We assessed convergence visually and using the @Gelman1992 diagnostic in the R package `coda' [@Plummer2006]. Scale reduction factors for all parameters were less than 1.01, indicating convergence. For the purposes of introducing stochasticity in our population models, we saved the final 1,000 iterations from each of the three MCMC chains for all parameters to be used as randomly drawn values during population simulation.

### Population models
With the posterior distribution of the vital rate statistical models in hand, it is straightforward to simulate the population models. We used an Integral Projection Model (IPM) to model populations based on individual level data and an quadrat based version of an individually-based model (Quadrat-Based Model, QBM) to model populations based on quadrat level data. Both models take the general form:

\begin{equation}
N_{t+1} = S \times G + R.
\end{equation}

So, at each time step in a simulation, we use the survival regression to determine if each genet lives or not (if each quadrat remains occupied or not), the growth regression to determine size changes of surviving individuals (cover change of occupied quadrats), and the recruitment regression to determine the number of new recruits (if a quadrat is colonized or not). We first use one-step-ahead forecasts to assess each model's ability to reproduce observed cover changes. Then we use the models to analyze the effect of potential climate changes on population size over long time scales.

We used random draws from the final 1,000 iterations from each of three MCMC chains to introduce stochasticity into our population models. At each time step, we randomly selected climate covariates from one of the 14 observed years. Then, we drew the full parameter set (climate effects and density-dependence fixed effects) from a randomly selected MCMC iteration. Since our focus was on the contribution of climate covariates to population states, we set the random year effects and the random group effects to zero.

### Model validation
To test each model's ability to forecast the population state we used leave-one-year-out cross validation. For both levels of modeling, we fit the vital rate models using observations from all years except one, and then used those fitted parameters in the population models to perform a one-step-ahead forecast for the year whose observations were withheld from model fitting. We repeated this procedure for all 13 observation years. This model validation allowed us to compare accuracy and precision of the two modeling approaches (individual-level versus population-level).

Results
-------
### Comparison of Forecast Models

### Forecasting Climate Change Impacts


Discussion
----------
We sought to test the assumption that the sensitivities of plant populations to climate variables can be detected equally well using either individual level data or population level data. This is an important question to answer because population models are key tools for predicting the consequences of global climate change. However, they can be of limited use when built on data from a small subset of a population in space or time. If population level data (i.e., some aggregated form of individual level data) can be used to detect climate effects on population dynamics, then we would have a cheaper and easier option for data collection over relatively large temporal and spatial extents [_e.g._ @Freckleton2011].

1. Climate detection
2. Limitations:
  * Sample size at quadrat level
  * are these species inherently sensitive to climate (compare to Chu and Adler in review -- say why we chose Montana site -- most sensitive to climate variables)
  * we know recruitment is important, and this is something that may be easily missed at quad level
3. Implications

\pagebreak{}

Tables
------
```{r table_1,results='asis',message=FALSE, comment=NA, echo=FALSE}
# Make a table for average residual from each model and year effects structure
ipm_onestep <- readRDS("../montana/ipm/simulations/one_step_results/ipm_one-step_forecasts_combined.rds")
qbm_onestep <- readRDS("../montana/quadBM/simulations/validation_results/qbm_one-step_forecasts_combined.rds")

#IPM
tmpipm <- ddply(ipm_onestep, .(quad, t1, species), summarise,
                mean_pred = mean(cover.t1),
                var_pred = var(cover.t1),
                mean_obs = mean(obs.cover.t1),
                resid = mean(resid))
ipmstats <- ddply(tmpipm, .(species), summarise,
                rho = cor(mean_pred, mean_obs),
                mae = mean(abs(resid)),
                var = mean(var_pred),
                mean_cover = mean(mean_obs*100))
ipmstats$model <- "IPM"

#QBM
tmpqbm <- ddply(qbm_onestep, .(quad, year, species), summarise,
                mean_pred = mean(predcov),
                var_pred = var(predcov),
                mean_obs = mean(obscov),
                resid = mean(resid))
qbmstats <- ddply(tmpqbm, .(species), summarise,
                rho = cor(mean_pred, mean_obs),
                mae = mean(abs(resid)),
                var = mean(var_pred),
                mean_cover = mean(mean_obs*100))
qbmstats$model <- "QBM"


mae_list <- list()
mae_pvals <- list()
species <- unique(qbmstats$species)
for(spp in species){
  tmp1 <- subset(tmpipm, species==spp)
  tmp2 <- subset(tmpqbm, species==spp)
  err1 <- as.data.frame(abs(tmp1$mean_obs - tmp1$mean_pred))
  err2 <- as.data.frame(abs(tmp2$mean_obs - tmp2$mean_pred))
  colnames(err1) <- "resid"
  err1$model <- "ipm"
  colnames(err2) <- "resid"
  err2$model <- "qbm"
  errd <-  rbind(err1, err2)
  mae_ttest <- with(errd, t.test(resid~model, alternative = "less"))
  mae_list[[spp]] <- mae_ttest
  mae_pvals[[spp]] <- mae_ttest[["p.value"]]
}

mae_ps <- melt(mae_pvals)

stats_table <- rbind(ipmstats, qbmstats)
stats_table <- stats_table[ order(stats_table[,"species"]), ]
stats_table <- stats_table[,c("species", "model", "mae",
                              "rho","mean_cover")]
# comment          <- list()
# comment$pos      <- list()
# comment$pos[[1]] <- c(nrow(stats_table))
# comment$command  <- c(paste("\\hline \n",  # we`ll replace all default hlines with this and the ones below
#                             "The IPM MAE is significantly lower for HECO ($p = 3.3\times10^{-10}$) and POSE ($p = 0.00013$. MAEs are statisticially similar between models for BOGR and PASM.   \n",
#                             sep = ""))

colnames(stats_table) <- c("Species", "Model", "MAE", "Accuracy", "Mean Obs. Cover")
print.xtable(xtable(stats_table, caption = "Mean absolute error (MAE) and accuracy (Pearson's $\\rho$) for one-step-ahead forecast from both model types. Forecasts were made without random year effects; only climate covariates could explain year-to-year variation."),type="latex", comment=FALSE,
             include.rownames=FALSE, caption.placement="top")
```
The IPM MAE is significantly lower for HECO ($p = 3.3 \times 10^{-10}$) and POSE ($p = 0.00013$). MAEs are statisticially similar between models for BOGR and PASM.

\pagebreak{}

Figures
-------
```{r figure_1,cache=FALSE, results='hide'}
# resD <- readRDS("../montana/quadBM/simulations/oneStepResids_YearEffects.rds")
# resDny <- readRDS("../montana/quadBM/simulations/oneStepResids_NoYearEffects.rds")
# resD$simtype <- rep("full", nrow(resD))
# resDny$simtype <- rep("noyear", nrow(resDny))
# resDall <- rbind(resD, resDny)
# noZ <- which(resDall$lagCover!=0)
# resDall <- resDall[noZ,]
# 
# myCols <- c("#237DA4", "#7ECAD0")
# # ggplot(resDall, aes(x=resids, fill=simtype))+
# #   geom_histogram(alpha=0.5)+
# #   facet_grid(.~species, scales = "free_x")+
# #   xlab("Year")+
# #   ylab("Residuals (% cover difference)")+
# #   theme_bw()+
# #   scale_fill_manual(values=myCols)
# 
# resAgg <- ddply(resDall, .(year, species, simtype), summarise,
#                 avg_prediction = mean(cover)*100,
#                 up_prediction = quantile(cover, probs = 0.875)*100,
#                 down_prediction = quantile(cover, probs = 0.125)*100,
#                 avg_obs = mean(propCover)*100)
# resAgg$model <- rep("QBM", nrow(resAggipm))

# ggplot(subset(resAgg))+
#   geom_ribbon(aes(x=year, ymin=down_prediction, ymax=up_prediction, fill=simtype), alpha=0.3)+
#   geom_line(aes(x=year, y=avg_prediction, color=simtype), size=1.5)+
# #   geom_line(aes(x=year, y=up_prediction, color=simtype), linetype=2, alpha=0.5)+
# #   geom_line(aes(x=year, y=down_prediction, color=simtype), linetype=2, alpha=0.5)+
#   geom_point(aes(x=year, y=avg_obs), shape=1, size=3)+
#   facet_grid(species~., scales="free")+
#   scale_fill_manual(values=c(myCols[1], "darkorange"), labels=c("Year effects", "No year effects"))+
#   scale_color_manual(values=c(myCols[1], "darkorange"))+
#   guides(color=FALSE)
# nSims <- length(unique(resD$sim))
# diffD <- ddply(resDall, c("year", "species", "simtype"), summarise,
#                avgDiff = median(resids, na.rm = TRUE),
#                upDiff75 = quantile(resids, probs = 0.8775, names=FALSE, na.rm = TRUE),
#                dnDiff75 = quantile(resids, probs = 0.1225, names=FALSE, na.rm = TRUE),
#                dnDiff95 = quantile(resids, probs = 0.025, names=FALSE, na.rm = TRUE),
#                upDiff95 = quantile(resids, probs = 0.975, names=FALSE, na.rm = TRUE))

# ggplot(diffD, aes(color=simtype))+
#   geom_hline(aes(yintercept=0), linetype=2, color="grey50")+
#   geom_point(aes(x=as.character(year), y=avgDiff), size=3, position=position_dodge(width=0.5))+
#   geom_errorbar(aes(x=as.character(year), ymax=upDiff95, ymin=dnDiff95), width=0.00001, position=position_dodge(width=0.5))+
#   geom_errorbar(aes(x=as.character(year), ymax=upDiff75, ymin=dnDiff75), size=1, width=0.00001, position=position_dodge(width=0.5))+
#   facet_grid(species~., scales = "free_y")+
#   xlab("Year")+
#   ylab("Residuals (% cover difference)")+
#   theme_bw()+
#   scale_color_manual(values=myCols)+
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))
# 
# ggplot(resDall)+
#   geom_hline(aes(yintercept=0), linetype=2)+
# #   geom_line(data=diffD, aes(x=year, y=avgDiff, group=species), color="purple", alpha=0.5)+
# #   stat_smooth(data=diffD, aes(x=year, y=avgDiff, group=species), color="lightblue", se = FALSE, size=1)+
#   geom_boxplot(aes(x=year, y=resids, fill=simtype), outlier.shape = 1, width=0.3, outlier.size = 0.5)+
#   facet_grid(species~., scales = "free_y")+
#   xlab("Year")+
#   ylab("Residuals (% cover difference)")+
#   theme_bw()+
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))
# myCols <- c("#237DA4", "#7ECAD0")
# p1 <- ggplot(subset(resDall, species=="BOGR"))+
#   geom_hline(aes(yintercept=0), linetype=2)+
#   geom_boxplot(aes(x=as.character(year), y=resids, fill=simtype), outlier.shape = 1, outlier.size = 0, color="grey25")+
#   xlab("Year")+
#   ylab("Residuals (% cover difference)")+
#   theme_bw()+
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))+
#   scale_fill_manual(values=myCols)+
#   coord_cartesian(ylim = c(-50, 50))+
#   ggtitle(expression(italic("B. gracilis")))+
#   guides(fill=FALSE)
# p2 <- ggplot(subset(resDall, species=="HECO"))+
#   geom_hline(aes(yintercept=0), linetype=2)+
#   geom_boxplot(aes(x=as.character(year), y=resids, fill=simtype), outlier.shape = 1, outlier.size = 0, color="grey25")+
#   xlab("Year")+
#   ylab("Residuals (% cover difference)")+
#   theme_bw()+
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))+
#   scale_fill_manual(values=myCols, labels=c("Year effects", "No year effects"))+
#   ggtitle(expression(italic("H. comita")))+
#   coord_cartesian(ylim = c(-10, 5))+
#   guides(fill=guide_legend(title=""))+
#   theme(legend.position=c(0.5,0.2))
# p3 <- ggplot(subset(resDall, species=="PASM"))+
#   geom_hline(aes(yintercept=0), linetype=2)+
#   geom_boxplot(aes(x=as.character(year), y=resids, fill=simtype), outlier.shape = 1, outlier.size = 0, color="grey25")+
#   xlab("Year")+
#   ylab("Residuals (% cover difference)")+
#   theme_bw()+
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))+
#   scale_fill_manual(values=myCols)+
#   ggtitle(expression(italic("P. smithii")))+
#   guides(fill=FALSE)+
#   coord_cartesian(ylim = c(-1.5, 1.5))
# p4 <- ggplot(subset(resDall, species=="POSE"))+
#   geom_hline(aes(yintercept=0), linetype=2)+
#   geom_boxplot(aes(x=as.character(year), y=resids, fill=simtype), outlier.shape = 1, outlier.size = 0, color="grey25")+
#   xlab("Year")+
#   ylab("Residuals (% cover difference)")+
#   theme_bw()+
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))+
#   scale_fill_manual(values=myCols)+
#   ggtitle(expression(italic("Poa secunda")))+
#   guides(fill=FALSE)+
#   coord_cartesian(ylim = c(-10, 15))
# pFinal <- grid.arrange(p1,p2,p3,p4, ncol=2, nrow=2)
# pFinal


```

```{r figure_2, dependson="plot-options", fig.cap="One step forecasts from IPM version.",fig.width=8, fig.height=8, cache=FALSE, results='hide'}
# resD <- readRDS("../montana/quadBM/simulations/oneStepResids_YearEffects.rds")
# resDny <- readRDS("../montana/quadBM/simulations/oneStepResids_NoYearEffects.rds")
# resD$simtype <- rep("full", nrow(resD))
# resDny$simtype <- rep("noyear", nrow(resDny))
# resDall <- rbind(resD, resDny)
# noZ <- which(resDall$lagCover!=0)
# resDall <- resDall[noZ,]
# 
# myCols <- c("#237DA4", "#7ECAD0")
# # ggplot(resDall, aes(x=resids, fill=simtype))+
# #   geom_histogram(alpha=0.5)+
# #   facet_grid(.~species, scales = "free_x")+
# #   xlab("Year")+
# #   ylab("Residuals (% cover difference)")+
# #   theme_bw()+
# #   scale_fill_manual(values=myCols)
# 
# resAgg <- ddply(resDall, .(year, species, simtype), summarise,
#                 avg_prediction = mean(cover)*100,
#                 up_prediction = quantile(cover, probs = 0.875)*100,
#                 down_prediction = quantile(cover, probs = 0.125)*100,
#                 avg_obs = mean(propCover)*100)
# resAgg$model <- rep("QBM", nrow(resAgg))
# 
# 
# 
# ipm_onestep <- readRDS("../montana/ipm/simulations/one_step_results/ipm_one-step_forecasts_combined.rds")
# ipm_onestep$t1 <- ipm_onestep$t1+1900
# 
# resAggipm <- ddply(ipm_onestep, .(t1, species, year), summarise,
#                 avg_prediction = mean(cover.t1)*100,
#                 up_prediction = quantile(cover.t1, probs = 0.875)*100,
#                 down_prediction = quantile(cover.t1, probs = 0.125)*100,
#                 avg_obs = mean(obs.cover.t1)*100)
# colnames(resAggipm)[1:3] <- c("year", "species", "simtype")
# resAggipm$simtype[which(resAggipm$simtype=="ayear effect")] <- "full"
# resAggipm$simtype[which(resAggipm$simtype!="full")] <- "noyear"
# resAggipm$model <- rep("IPM", nrow(resAggipm))
# 
# resAgg_both <- rbind(resAgg, resAggipm)
# 
# ggplot(subset(resAgg_both))+
#   geom_ribbon(aes(x=year, ymin=down_prediction, ymax=up_prediction, fill=simtype), alpha=0.3)+
#   geom_line(aes(x=year, y=avg_prediction, color=simtype), size=1.5)+
#   geom_point(aes(x=year, y=avg_obs), shape=1, size=3)+
#   facet_grid(species~model, scales="free")+
#   scale_fill_manual(values=c(myCols[1], "darkorange"), labels=c("Year effects", "No year effects"))+
#   scale_color_manual(values=c(myCols[1], "darkorange"))+
#   guides(color=FALSE)
# 
# ggplot(subset(resAgg_both))+
#   geom_ribbon(aes(x=year, ymin=down_prediction, ymax=up_prediction, fill=model), alpha=0.3)+
#   geom_line(aes(x=year, y=avg_prediction, color=model), size=1.5)+
#   geom_point(aes(x=year, y=avg_obs), shape=1, size=3)+
#   facet_grid(species~simtype, scales="free")+
#   scale_fill_manual(values=c(myCols[1], "darkorange"))+
#   scale_color_manual(values=c(myCols[1], "darkorange"))+
#   guides(color=FALSE)


# p1 <- ggplot(subset(ipm_onestep, species=="BOGR"))+
#   geom_hline(aes(yintercept=0), linetype=2)+
#   geom_boxplot(aes(x=as.character(t1),y=resid,fill=year), outlier.shape = 1, outlier.size = 0, color="grey25")+
#   xlab("Year")+
#   ylab("Residuals (% cover difference)")+
#   theme_bw()+
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))+
#   scale_fill_manual(values=myCols)+
#   coord_cartesian(ylim = c(-50, 50))+
#   ggtitle(expression(italic("B. gracilis")))+
#   guides(fill=FALSE)
# p2 <- ggplot(subset(ipm_onestep, species=="HECO"))+
#   geom_hline(aes(yintercept=0), linetype=2)+
#   geom_boxplot(aes(x=as.character(t1),y=resid,fill=year), outlier.shape = 1, outlier.size = 0, color="grey25")+
#   xlab("Year")+
#   ylab("Residuals (% cover difference)")+
#   theme_bw()+
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))+
#   scale_fill_manual(values=myCols, labels=c("Year effects", "No year effects"))+
#   ggtitle(expression(italic("H. comita")))+
#   coord_cartesian(ylim = c(-10, 5))+
#   guides(fill=guide_legend(title=""))+
#   theme(legend.position=c(0.5,0.2))
# p3 <- ggplot(subset(ipm_onestep, species=="PASM"))+
#   geom_hline(aes(yintercept=0), linetype=2)+
#   geom_boxplot(aes(x=as.character(t1),y=resid,fill=year), outlier.shape = 1, outlier.size = 0, color="grey25")+
#   xlab("Year")+
#   ylab("Residuals (% cover difference)")+
#   theme_bw()+
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))+
#   scale_fill_manual(values=myCols)+
#   ggtitle(expression(italic("P. smithii")))+
#   guides(fill=FALSE)+
#   coord_cartesian(ylim = c(-1.5, 1.5))
# p4 <- ggplot(subset(ipm_onestep, species=="POSE"))+
#   geom_hline(aes(yintercept=0), linetype=2)+
#   geom_boxplot(aes(x=as.character(t1),y=resid,fill=year), outlier.shape = 1, outlier.size = 0, color="grey25")+
#   xlab("Year")+
#   ylab("Residuals (% cover difference)")+
#   theme_bw()+
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))+
#   scale_fill_manual(values=myCols)+
#   ggtitle(expression(italic("Poa secunda")))+
#   guides(fill=FALSE)+
#   coord_cartesian(ylim = c(-10, 15))
# pFinal <- grid.arrange(p1,p2,p3,p4, ncol=2, nrow=2)
# pFinal
```

```{r figure_3, dependson="plot-options", fig.cap="One step forecasts from IPM version.",fig.width=8, fig.height=8, cache=FALSE, results='hide', eval=FALSE}
# ipm_onestep2 <- subset(ipm_onestep, year=="ayear effect")
# resDall2 <- subset(resDall, simtype=="full")
# ipm_qbm_onestep <- data.frame(year = c(ipm_onestep2$t1, resDall2$year),
#                               resids = c(ipm_onestep2$resid, resDall2$resids),
#                               model = c(rep("IPM", nrow(ipm_onestep2)),
#                                         rep("QBM", nrow(resDall2))),
#                               species = c(ipm_onestep2$species, resDall2$species))
# g1 <- ggplot(subset(ipm_qbm_onestep, species=="BOGR"))+
#   geom_hline(aes(yintercept=0), linetype=2)+
#   geom_boxplot(aes(x=as.character(year),y=resids,fill=model), outlier.shape = 1, outlier.size = 0, color="grey25")+
#   xlab("Year")+
#   ylab("Residuals (% cover difference)")+
#   theme_bw()+
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))+
#   scale_fill_manual(values=myCols)+
#   coord_cartesian(ylim = c(-50, 50))+
#   ggtitle(expression(italic("B. gracilis")))+
#   guides(fill=FALSE)
# g2 <- ggplot(subset(ipm_qbm_onestep, species=="HECO"))+
#   geom_hline(aes(yintercept=0), linetype=2)+
#   geom_boxplot(aes(x=as.character(year),y=resids,fill=model), outlier.shape = 1, outlier.size = 0, color="grey25")+
#   xlab("Year")+
#   ylab("Residuals (% cover difference)")+
#   theme_bw()+
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))+
#   scale_fill_manual(values=myCols)+
#   coord_cartesian(ylim = c(-10, 5))+
#   ggtitle(expression(italic("H. comata")))+
#   guides(fill=guide_legend(title=""))+
#   theme(legend.position=c(0.5,0.2))
# g3 <- ggplot(subset(ipm_qbm_onestep, species=="PASM"))+
#   geom_hline(aes(yintercept=0), linetype=2)+
#   geom_boxplot(aes(x=as.character(year),y=resids,fill=model), outlier.shape = 1, outlier.size = 0, color="grey25")+
#   xlab("Year")+
#   ylab("Residuals (% cover difference)")+
#   theme_bw()+
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))+
#   scale_fill_manual(values=myCols)+
#   ggtitle(expression(italic("P. smithii")))+
#   guides(fill=FALSE)+
#   coord_cartesian(ylim = c(-1.5, 1.5))
# g4 <- ggplot(subset(ipm_qbm_onestep, species=="POSE"))+
#   geom_hline(aes(yintercept=0), linetype=2)+
#   geom_boxplot(aes(x=as.character(year),y=resids,fill=model), outlier.shape = 1, outlier.size = 0, color="grey25")+
#   xlab("Year")+
#   ylab("Residuals (% cover difference)")+
#   theme_bw()+
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))+
#   scale_fill_manual(values=myCols)+
#   ggtitle(expression(italic("Poa secunda")))+
#   coord_cartesian(ylim = c(-10, 15))+
#   guides(fill=FALSE)
# pFinal <- grid.arrange(g1,g2,g3,g4, ncol=2, nrow=2)
# pFinal
```

```{r ipm_climeffs, cache=FALSE, results='hide', include=FALSE}
source("../montana/ipm/vitalRateRegs/climate_effects_plots.R")
```

![Standardized regression coefficients for climate effects in the vital rate models for the IPM. Shown are the median (circles), 75% confidence intervals (thick lines), and 95% confidence intervals (thin lines). Left panels (black) are for the growth regressions; middle panels (blue) are for the survival regressions; right panels (orange) are for the recruitment regressions.](components/figure/ipm_climeffs.pdf)

```{r quad_climeffs, cache=FALSE, results='hide', include=FALSE}
source("../montana/quadBM/vitalRateRegressions/truncNormModel/climate_effects_plot.R")
```

![Standardized regression coefficients for climate effects in the vital rate models for the QBM. Shown are the median (circles), 75% confidence intervals (thick lines), and 95% confidence intervals (thin lines).](components/figure/qbm_climeffs.pdf)

```{r figure_4, dependson="plot-options", fig.cap="Proportional change in species' mean cover caused by a 1% increase in observed precipitation, temperature, or both as predicted by the individual-based IPM and the aggregate-based QBM. Note that the change for POSE due to a precipitation increase predicted by the QBM is almost zero and so does not show up in the figure. Labels on x-axis refer to: 'ppt' = 1% increase in mean precipitation; 'temp' = 1% increase in mean temperature; 'ppt + temp' = 1% increase in mean precipitation and mean temperature.", fig.width=6.5, fig.height=6, cache=FALSE, results='hide'}
qbm_diffs <- readRDS("../montana/quadBM/simulations/results/qbm_climatesims_percdiffs.rds")
qbm_diffs$type <- rep("QBM", nrow(qbm_diffs))
ipm_diffs <- readRDS("../montana/ipm/simulations/results/ipm_climatesims_percdiffs.rds")
ipm_diffs$type <- rep("IPM", nrow(ipm_diffs))

diff_df <- rbind(qbm_diffs, ipm_diffs)

myCols2 <- c("grey45", "#277BA8", "#7ABBBD", "#AED77A")
# ggplot(climSimsQBM)+
#   geom_boxplot(aes(x=species, y=cover*100, fill=sim), outlier.size=0)+
#   theme_bw()+
#   coord_cartesian(ylim=c(0,50))+
#   scale_fill_manual(name="", labels=c("Observed", "1% Precipitation Increase", "1% Temperature Increase", "1% Temp. & Ppt. Increase"), values=myCols2)
ggplot(diff_df, aes(x=sim, y=value, fill=type))+
  geom_bar(stat="identity", position="dodge")+
  geom_hline(aes(yintercept=0))+
  scale_fill_manual(values = myCols2[c(1,3)], name="Model type")+
  xlab("Climatic change")+
  ylab("Proportional change in percent cover")+
  facet_wrap("variable", scales = "free")+
  scale_x_discrete(labels=c("ppt", "temp", "ppt + tmp"))+
  theme_bw()
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))



# climSimsQBMavg <- ddply(climSimsQBM, .(sim, species), summarise,
#                         avgCover = median(cover))
# climSimQBMcast <- dcast(climSimsQBMavg, formula = species~sim)
# climSimQBMcast$diffP <- with(climSimQBMcast, (Precipitation*100)-(Observed*100)) 
# climSimQBMcast$diffT <- with(climSimQBMcast, (Temperature*100)-(Observed*100))
# climSimQBMcast$diffB <- with(climSimQBMcast, (Both*100)-(Observed*100))
# climSimQBMplot <- melt(climSimQBMcast)
# climSimQBMplot <- subset(climSimQBMplot, species!="POSE")
# 
# ggplot(data=subset(climSimQBMplot, variable=="diffP"|variable=="diffT"|variable=="diffB"))+
#   geom_bar(aes(x=species, y=value, fill=variable), stat="identity", position="dodge", color="white")+
#   scale_fill_manual(name="", labels=c("1% Precipitation Increase", "1% Temperature Increase", "1% Temp. & Ppt. Increase"), values=myCols2)+
#   theme_bw()+
#   theme(legend.position=c(0.6, 0.8))+
#   ylab("Cover Change (%)")+
#   xlab("Species")
```

\pagebreak{}

References
----------

---
layout: 12pt
header-includes:
   - \usepackage{lineno}
   - \linenumbers
   - \usepackage{setspace}
bibliography: ~/Dropbox/Bibliography/MicroMeso.bib
csl: components/ecology.csl

## rmarkdown render options
output:
  pdf_document:
    fig_caption: true
    keep_tex: true
fontsize: 12pt
geometry: margin=1in

---

\renewcommand\thefigure{C\arabic{figure}} 

```{r caching, include=FALSE}
library("methods")
library("knitr")
basename <- "appC"
opts_chunk$set(fig.path = paste("appC/figure/", basename, "-", sep=""),
               cache.path = paste("appC/cache/", basename, "/", sep=""))
opts_chunk$set(cache = 2)
opts_chunk$set(tidy=FALSE, warning=FALSE, message=FALSE, 
               comment = NA, verbose = TRUE, echo=FALSE)

# PDF-based figures
opts_chunk$set(dev='pdf')
```

Appendix C: Effect of recruitment on IPM uncertainty
=====================================================
In Fig. 4 of the main text where we show the uncertainty around our models' forecasts to a 1% change in climate covariates, the obvious outlier is *Pascopyrum smithii* (PASM). The uncertainty around PASM forecasts from the integral projection model is orders of magnitude larger than for any other species, and is even larger than the uncertainty around the quad-based model forecasts. It turns out that the estimated dispersion parameter for the negative binomial distribution is much higher for PASM than for other species (Appendix B). This is because PASM has higher recruitment rates than the other species and the relationship between number of recruits and quadrat cover (see main text) is weak. So, when we draw parameters from the MCMC chain for our simulations, even larger values for the dispersion parameter are possible. Thus, there can be very large "boom" years where recruitment is high. When we allow all parameters to vary except those associated with recruitment, uncertainty around PASM decreases to levels similar to those associated with other species (Fig. C1).

```{r plot-options, message=FALSE, warning=FALSE, include=FALSE, echo=FALSE}
cbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", 
               "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

opts_chunk$set(dev='pdf', dev.args=c(version="1.3"))

```

```{r plot_it, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE, fig.width=5, fig.height=3, fig.cap="Mean (points) and 90% quantiles (errorbars) for the proportional difference between baseline simulations (using observed climate) and the climate pertubation simulation on the x-axis. We calculated proportional difference as log(perturbed climate cover) - log(observed climate cover), where 'perturbed' and 'observed' refer to the climate time series used to drive interannual variation in the simulations. Model error and parameter uncertainty were propagated through the simulation phase for all vital rates except recruitment.", dependson="plot-options"}
library(plyr)
library(ggplot2)
setwd("~/Repos/MicroMesoForecast/analysis/")
meanparam_ipm <- data.frame(cover=NA, species=NA, 
                             climsim=NA, model=NA)
##  IPM 
path <- "./ipm/simulations/results/cc_rectest/"
ipmfiles_mean <- list.files(path)
ipmfiles_mean <- ipmfiles_mean[grep("cover", ipmfiles_mean)]
for(file in ipmfiles_mean){
  tmp <- read.csv(paste(path,file,sep=""))
  tmp$model <- "IPM"
  meanparam_ipm <- rbind(meanparam_ipm, tmp[,c("cover", "species", "climsim", "model")])
}
meanparam_ipm <- meanparam_ipm[2:nrow(meanparam_ipm),]

newd <- data.frame(cover=NA, species=NA, 
                   climsim=NA, model=NA, obscover=NA)
for(dospp in unique(meanparam_ipm$species)){
  tmp <- subset(meanparam_ipm, species==dospp)
  obscover <- subset(tmp, climsim=="obs")["cover"]
  tmp2 <- subset(tmp, climsim!="obs")
  tmp2$obscover <- rep(obscover$cover, times = length(unique(tmp2$climsim)))
  newd <- rbind(newd, tmp2)
}
ipm_meansims <- newd[2:nrow(newd),]
ipm_meansims$propdiff <- with(ipm_meansims, log(cover*100)-log(obscover*100))

meanparam_agg <- ddply(ipm_meansims, .(species, climsim, model), summarise,
                       meandiff = mean(propdiff),
                       hidiff = quantile(propdiff, probs = 0.95),
                       lodiff = quantile(propdiff, probs = 0.05))
dgd = position_dodge(width = 0.6)
ggplot(meanparam_agg, aes(color=species))+
  geom_errorbar(aes(x=climsim, ymax=hidiff, ymin=lodiff),
                position=dgd, width=0.25)+
  geom_point(aes(x=climsim, y=meandiff),
                position=dgd, width=0.25)+
  theme_bw()+
#   facet_wrap("species", ncol=1, scales="free")+
  scale_x_discrete(labels=c("+ppt", "+temp", "+ppt&temp"))+
  ylab("Proportional difference")+
  xlab("Climate simulation")+
  scale_color_manual(values=cbPalette[1:4])
```

---
layout: 12pt
header-includes:
   - \usepackage{lineno}
   - \linenumbers
   - \usepackage{setspace}
bibliography: ~/Dropbox/Bibliography/MicroMeso.bib
csl: components/ecology.csl

## rmarkdown render options
output:
  pdf_document:
    fig_caption: true
    keep_tex: true
fontsize: 12pt
geometry: margin=1in

---

\renewcommand\thefigure{D\arabic{figure}} 

```{r caching, include=FALSE}
library("methods")
library("knitr")
basename <- "appD"
opts_chunk$set(fig.path = paste("appD/figure/", basename, "-", sep=""),
               cache.path = paste("appD/cache/", basename, "/", sep=""))
opts_chunk$set(cache = 2)
opts_chunk$set(tidy=FALSE, warning=FALSE, message=FALSE, 
               comment = NA, verbose = TRUE, echo=FALSE)

# PDF-based figures
opts_chunk$set(dev='pdf')
```

Appendix D: Model forecasts without parameter uncertainty
=========================================================
In the main text we show results from model forecasts where we included full model and parameter uncertainty (Fig. 6). However, the typical approach in ecology is to use point estimates of model parameters and only include model error. For example, to predict population size *N* at time *t+1* one could do the following:

\begin{align}
\mu_{t+1} &= f(N_{t}) \\
N_{t+1} &\sim \text{Normal}(\mu_{t+1}, \sigma^2)
\end{align}

where $f(N_t)$ is some determinstic process (e.g., a linear regression model) and $\sigma^2$ is the model error. Simulating populations in such a way ignores variation in the parameters of $f(N_t)$. When we take this approach to making forecasts of equilibrium cover under 1% climate changes the IPM and QBM make opposing predictions if we simply look at the mean projection (Fig. D1). For both models, precision is also artificially high (Fig. D2 and D3), since we know that parameter uncertainty reduces forecast precision considerably (Fig. 6 in the main text). All three presentations of model results (mean projection, mean projection with model error, and forecasts with full uncertainty) can be found in the literature, which is why we present them here as well. However, as we state in the main text, true forecasts should only be presented as we did in Fig. 6 of the main text.

```{r plot-options, message=FALSE, warning=FALSE, include=FALSE, echo=FALSE}
cbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", 
               "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

opts_chunk$set(dev='pdf', dev.args=c(version="1.3"))

```

```{r figure_d1, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE, fig.width=8.5, fig.height=4, fig.cap="Projected proportional changes in equilibrium cover caused by a 1% increase in observed precipitation (+ppt), temperature (+temp), or both (+ppt&temp) as predicted by the individual-level IPM and the population-level QBM using mean parameter values.", dependson="plot-options"}
library(plyr)
library(ggplot2)
library(gridExtra)
####
##  Mean parameter runs
####
setwd("~/Repos/MicroMesoForecast/analysis/")
meanparam_ipm <- data.frame(cover=NA, species=NA, 
                             climsim=NA, model=NA)
##  IPM 
path <- "./ipm/simulations/results/climchange_meanparams/"
ipmfiles_mean <- list.files(path)
ipmfiles_mean <- ipmfiles_mean[grep("cover", ipmfiles_mean)]
for(file in ipmfiles_mean){
  tmp <- read.csv(paste(path,file,sep=""))
  tmp$model <- "IPM"
  meanparam_ipm <- rbind(meanparam_ipm, tmp[,c("cover", "species", "climsim", "model")])
}
meanparam_ipm <- meanparam_ipm[2:nrow(meanparam_ipm),]

newd <- data.frame(cover=NA, species=NA, 
                   climsim=NA, model=NA, obscover=NA)
for(dospp in unique(meanparam_ipm$species)){
  tmp <- subset(meanparam_ipm, species==dospp)
  obscover <- subset(tmp, climsim=="obs")["cover"]
  tmp2 <- subset(tmp, climsim!="obs")
  tmp2$obscover <- rep(obscover$cover, times = length(unique(tmp2$climsim)))
  newd <- rbind(newd, tmp2)
}
ipm_meansims <- newd[2:nrow(newd),]
ipm_meansims$propdiff <- with(ipm_meansims, log(cover*100)-log(obscover*100))

##  QBM
meanparam_qbm <- data.frame(cover=NA, species=NA, 
                             climsim=NA, model=NA)
path <- "./quadBM/simulations/results/climatechange_meanparams/"
qbmfiles_mean <- list.files(path)
for(file in qbmfiles_mean){
  tmp <- readRDS(paste(path,file,sep=""))
  tmp$model <- "QBM"
  meanparam_qbm <- rbind(meanparam_qbm, tmp[,c("cover", "species", "climsim", "model")])
}
meanparam_qbm <- meanparam_qbm[2:nrow(meanparam_qbm),]

newd <- data.frame(cover=NA, species=NA, 
                   climsim=NA, model=NA, obscover=NA)
for(dospp in unique(meanparam_qbm$species)){
  tmp <- subset(meanparam_qbm, species==dospp)
  obscover <- subset(tmp, climsim=="obs")["cover"]
  tmp2 <- subset(tmp, climsim!="obs")
  tmp2$obscover <- rep(obscover$cover, times = length(unique(tmp2$climsim)))
  newd <- rbind(newd, tmp2)
}
qbm_meansims <- newd[2:nrow(newd),]
qbm_meansims$propdiff <- with(qbm_meansims, log(cover*100)-log(obscover*100))

##  Merge IPM and QBM mean parameter results
bothmodel_outs <- rbind(ipm_meansims, qbm_meansims)
meanparam_agg <- ddply(bothmodel_outs, .(species, climsim, model), summarise,
                       meandiff = mean(propdiff),
                       hidiff = quantile(propdiff, probs = 0.95),
                       lodiff = quantile(propdiff, probs = 0.05))
dgd = position_dodge(width = 0.9)
meanplot <- ggplot(meanparam_agg)+
  geom_bar(aes(x=climsim, y=meandiff, fill=model),
             position=dgd, stat="identity")+
  theme_bw()+
  scale_fill_manual(values=c("black", "grey45"), name="Model")+
  facet_wrap("species", scales="free", nrow=1)+
  scale_x_discrete(labels=c("+ppt", "+temp", "+ppt&temp"))+
  ylab("Mean proportional difference")+
  xlab("Climate simulation")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(meanplot)
```

```{r figure_d2, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE, fig.width=8.5, fig.height=4, fig.cap="Projected mean (points) proportional changes in equilibrium cover and associated 90% quantiles (errorbars) caused by a 1% increase in observed precipitation (+ppt), temperature (+temp), or both (+ppt&temp) as predicted by the individual-level IPM using mean parameter values. Dashed line indicates proportional change of 0.", dependson="plot-options"}

errorplot1 <- ggplot(subset(meanparam_agg, model=="IPM"))+
  geom_point(aes(x=climsim, y=meandiff),
             position=dgd, stat="identity")+
  geom_errorbar(aes(x=climsim, ymax=hidiff, ymin=lodiff),
                position=dgd, width=0.25)+
  geom_hline(aes(yintercept=0), linetype=2)+
  theme_bw()+
  facet_wrap("species", scales="free", nrow=1)+
  scale_x_discrete(labels=c("+ppt", "+temp", "+ppt&temp"))+
  ylab("Mean proportional difference")+
  xlab("Climate simulation")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
print(errorplot1)
# print(meanplot)
```

```{r figure_d3, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE, fig.width=8.5, fig.height=4, fig.cap="Projected mean (points) proportional changes in equilibrium cover and associated 90% quantiles (errorbars) caused by a 1% increase in observed precipitation (+ppt), temperature (+temp), or both (+ppt&temp) as predicted by the population-level QBM using mean parameter values. Dashed line indicates proportional change of 0.", dependson="plot-options"}

errorplot2 <- ggplot(subset(meanparam_agg, model=="QBM"))+
  geom_point(aes(x=climsim, y=meandiff),
             position=dgd, stat="identity")+
  geom_errorbar(aes(x=climsim, ymax=hidiff, ymin=lodiff),
                position=dgd, width=0.25)+
  geom_hline(aes(yintercept=0), linetype=2)+
  theme_bw()+
  facet_wrap("species", scales="free", nrow=1)+
  scale_x_discrete(labels=c("+ppt", "+temp", "+ppt&temp"))+
  ylab("Mean proportional difference")+
  xlab("Climate simulation")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
print(errorplot2)
# print(meanplot)
```

---
title: "Do we need detailed demographic data to forecast the impacts of climate change on plant populations?"
author: "Andrew Tredennick and Peter Adler"
date: " "
output: beamer_presentation
---

## This is hard...

\begin{center}
{\includegraphics{idaho_field.pdf}}
\end{center}

## This is hard...

\begin{center}
{\includegraphics{idaho_field.pdf}}
\end{center}

## Density-structured population models

\begin{center}
{\includegraphics{freck.png}}
\end{center}

## Ecological fallacy

"...individuals respond to weather, not populations to climate."

-- Clark 2011 (Ecology Letters)

## Data

```{r, echo=FALSE, include=TRUE, warning=FALSE, message=FALSE, fig.height=6}
library(plyr)
library(reshape2)
library(ggplot2)
obs_data <- read.csv("../analysis/speciesData/quadAllCover.csv")
#remove zeros for averaging
obs_data <- obs_data[which(obs_data$propCover>0),]
avgobs <- ddply(obs_data, .(year, Species), summarise,
                mean_cover = mean(propCover))

ggplot()+
  geom_line(data = obs_data, aes(x=(1900+year), y=propCover*100, group=quad), 
            color="purple", size=0.25, alpha=0.25)+
  geom_line(data=avgobs, aes(x=(1900+year), y=mean_cover*100))+
  geom_point(data=avgobs, aes(x=(1900+year), y=mean_cover*100),size=3)+
  ylab("Mean cover (%)")+
  xlab("Year")+
  theme_bw()+
  facet_wrap("Species", ncol=2, nrow=2, scales = "free")+
  guides(shape=FALSE, linetype=FALSE)
```

## Data

\begin{center}
{\includegraphics{micromeso_flowchart.png}}
\end{center}

## Models

1. Integral projection model (IPM)
    + Survival: $p(S) = f(x_{t} + climate + density dependence)$
    + Growth: $x_{t+1} = f(x_{t} + climate + density dependence)$
    + Recruitment: $n_{t+1} = f(parents + climate)$

2. Quadrat based model (QBM)
    + Population growth: $c_{t+1} = f(c_{t} + climate)$

##  Model performance

```{r, echo=FALSE, include=TRUE, warning=FALSE, message=FALSE, fig.height=4}
####
##  Make a table for average residual from each model and year effects structure
####

##  IPM results
# Read in data
ipm_onestep <- readRDS("../analysis/ipm/simulations/results/one_step_validation/ipm_loyo_forecasts_combined.rds")
# Remove predictions >1 for fair comparison to [0,1] truncated quad model
resets <- which(ipm_onestep[,"cover.t1"]>1)
ipm_onestep[resets, "cover.t1"] <- 1
# Average predictions over quad-year reps
avg_ipm <- ddply(ipm_onestep, .(species, quad, t1), summarise,
                 avg_prediction = median(cover.t1),
                 observation = mean(cover.t0),
                 quant_dist = quantile(cover.t1*100, probs = 0.95) - quantile(cover.t1, probs = 0.05))
# Calculate error
avg_ipm$error <- avg_ipm$observation*100 - avg_ipm$avg_prediction*100
# Aggregate over species
ipmstats <- ddply(avg_ipm, .(species), summarise,
                  mae = mean(abs(error)),
                  mean_cover = mean(observation*100),
                  quant_dist = mean(quant_dist))
ipmstats$model <- "IPM"


##  QBM results
# Read in data
qbm_onestep <- readRDS("../analysis/quadBM/simulations/results/one_step_validation/qbm_one-step_forecasts_combined.rds")
# Average predictions over quad-year reps
avg_qbm <- ddply(qbm_onestep, .(species, quad, year), summarise,
                 avg_prediction = median(cover.t1),
                 observation = mean(cover.t0),
                 quant_dist = quantile(cover.t1*100, probs = 0.95) - quantile(cover.t1, probs = 0.05))
# Calculate error
avg_qbm$error <- avg_qbm$observation*100 - avg_qbm$avg_prediction*100
# Aggregate over species
qbmstats <- ddply(avg_qbm, .(species), summarise,
                  mae = mean(abs(error)),
                  mean_cover = mean(observation*100),
                  quant_dist = mean(quant_dist))
qbmstats$model <- "QBM"



mae_list <- list()
mae_pvals <- list()
species <- unique(qbmstats$species)
for(spp in species){
  tmp1 <- subset(avg_ipm, species==spp)
  tmp2 <- subset(avg_qbm, species==spp)
  err1 <- as.data.frame(abs(tmp1$observation - tmp1$avg_prediction))
  err2 <- as.data.frame(abs(tmp2$observation - tmp2$avg_prediction))
  colnames(err1) <- "resid"
  err1$model <- "ipm"
  colnames(err2) <- "resid"
  err2$model <- "qbm"
  errd <-  rbind(err1, err2)
  mae_ttest <- with(errd, t.test(resid~model, alternative = "less"))
  mae_list[[spp]] <- mae_ttest
  mae_pvals[[spp]] <- mae_ttest[["p.value"]]
}

mae_ps <- melt(mae_pvals)

stats_table <- rbind(ipmstats, qbmstats)
stats_table <- stats_table[ order(stats_table[,"species"]), ]
stats_table <- stats_table[,c("species", "model", "mae",
                              "quant_dist","mean_cover")]
colnames(stats_table)[3:4] <- c("mean absolute error", "quantile distance")
plotd <- melt(stats_table, id.vars = c("species", "model"))

ggplot(subset(plotd, variable!="mean_cover"), aes(x=species, y=value, fill=model))+
  geom_bar(stat="identity", position="dodge")+
  facet_wrap("variable", nrow=1, scales="free")+
  scale_fill_manual(values = c("darkorange", "steelblue"))
```